import{_ as e,d as t,f as n,g as r,h as i,m as a,p as o,u as s,v as c,y as l}from"./show-BKtqouzF.js";import{b as u,d,g as f,i as p,j as m,k as h,o as g,p as _}from"./index-BBZq5bNO.js";function v(e,t){let n=new Set(t);return e.filter(e=>!n.has(e))}function y(e,t,n){let r=e.slice(0);return r[t]=n,r}var b=class extends u{#client;#result;#queries;#options;#observers;#combinedResult;#lastCombine;#lastResult;#observerMatches=[];constructor(e,t,n){super(),this.#client=e,this.#options=n,this.#queries=[],this.#observers=[],this.#result=[],this.setQueries(t)}onSubscribe(){this.listeners.size===1&&this.#observers.forEach(e=>{e.subscribe(t=>{this.#onUpdate(e,t)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,this.#observers.forEach(e=>{e.destroy()})}setQueries(e,t){this.#queries=e,this.#options=t,g.batch(()=>{let e=this.#observers,t=this.#findMatchingObservers(this.#queries);this.#observerMatches=t,t.forEach(e=>e.observer.setOptions(e.defaultedQueryOptions));let n=t.map(e=>e.observer),r=n.map(e=>e.getCurrentResult()),i=e.length!==n.length,a=n.some((t,n)=>t!==e[n]),o=i||a,s=o?!0:r.some((e,t)=>{let n=this.#result[t];return!n||!f(e,n)});!o&&!s||(o&&(this.#observers=n),this.#result=r,this.hasListeners()&&(o&&(v(e,n).forEach(e=>{e.destroy()}),v(n,e).forEach(e=>{e.subscribe(t=>{this.#onUpdate(e,t)})})),this.#notify()))})}getCurrentResult(){return this.#result}getQueries(){return this.#observers.map(e=>e.getCurrentQuery())}getObservers(){return this.#observers}getOptimisticResult(e,t){let n=this.#findMatchingObservers(e),r=n.map(e=>e.observer.getOptimisticResult(e.defaultedQueryOptions));return[r,e=>this.#combineResult(e??r,t),()=>this.#trackResult(r,n)]}#trackResult(e,t){return t.map((n,r)=>{let i=e[r];return n.defaultedQueryOptions.notifyOnChangeProps?i:n.observer.trackResult(i,e=>{t.forEach(t=>{t.observer.trackProp(e)})})})}#combineResult(e,t){return t?((!this.#combinedResult||this.#result!==this.#lastResult||t!==this.#lastCombine)&&(this.#lastCombine=t,this.#lastResult=this.#result,this.#combinedResult=_(this.#combinedResult,t(e))),this.#combinedResult):e}#findMatchingObservers(e){let t=new Map(this.#observers.map(e=>[e.options.queryHash,e])),n=[];return e.forEach(e=>{let r=this.#client.defaultQueryOptions(e),i=t.get(r.queryHash);i?n.push({defaultedQueryOptions:r,observer:i}):n.push({defaultedQueryOptions:r,observer:new l(this.#client,r)})}),n}#onUpdate(e,t){let n=this.#observers.indexOf(e);n!==-1&&(this.#result=y(this.#result,n,t),this.#notify())}#notify(){if(this.hasListeners()){let e=this.#combinedResult,t=this.#trackResult(this.#result,this.#observerMatches),n=this.#combineResult(t,this.#options?.combine);e!==n&&g.batch(()=>{this.listeners.forEach(e=>{e(this.#result)})})}}},x=m(h());function S({queries:u,...f},m){let h=p(m),_=c(),v=e(),y=x.useMemo(()=>u.map(e=>{let t=h.defaultQueryOptions(e);return t._optimisticResults=_?`isRestoring`:`optimistic`,t}),[u,h,_]);y.forEach(e=>{s(e),a(e,v)}),r(v);let[S]=x.useState(()=>new b(h,y,f)),[C,w,T]=S.getOptimisticResult(y,f.combine),E=!_&&f.subscribed!==!1;x.useSyncExternalStore(x.useCallback(e=>E?S.subscribe(g.batchCalls(e)):d,[S,E]),()=>S.getCurrentResult(),()=>S.getCurrentResult()),x.useEffect(()=>{S.setQueries(y,f)},[y,f,S]);let D=C.some((e,t)=>n(y[t],e))?C.flatMap((e,r)=>{let i=y[r];if(i){let r=new l(h,i);if(n(i,e))return t(i,r,v);o(e,_)&&t(i,r,v)}return[]}):[];if(D.length>0)throw Promise.all(D);let O=C.find((e,t)=>{let n=y[t];return n&&i({result:e,errorResetBoundary:v,throwOnError:n.throwOnError,query:h.getQueryCache().get(n.queryHash),suspense:n.suspense})});if(O?.error)throw O.error;return w(T())}export{S as t};